<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Â§ö Agent ËÅäÂ§©ÁïåÈù¢</title>
    <style>
        body {
            min-height: 100vh;
            margin: 0;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #3a8dde 0%, #1e3c72 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }
        
        /* Âä†ËΩΩÂä®ÁîªÊ†∑Âºè */
        .loading-bubble {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 16px;
            background: #e6f0fa;
            border-radius: 16px;
            margin-bottom: 8px;
        }
        
        .loading-dots {
            display: flex;
            align-items: center;
        }
        
        .loading-dots span {
            width: 8px;
            height: 8px;
            margin: 0 2px;
            background-color: #3a8dde;
            border-radius: 50%;
            display: inline-block;
            animation: loading 1.4s infinite ease-in-out both;
        }
        
        .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes loading {
            0%, 80%, 100% { 
                transform: scale(0);
            } 40% { 
                transform: scale(1.0);
            }
        }
        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .sidebar {
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }
        .agent-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            margin-bottom: 8px;
            transition: box-shadow 0.2s;
        }
        .agent-icon.selected {
            box-shadow: 0 0 0 3px #3a8dde;
        }
        .remove-agent {
            display: none;
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: #ff4d4f;
            color: #fff;
            border-radius: 50%;
            font-size: 16px;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 2;
        }
        .agent-icon:hover .remove-agent {
            display: flex;
        }
        .add-agent {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #3a8dde;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 16px;
        }
        .model-select-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            padding: 20px;
            box-sizing: border-box;
        }
        .model-select-sidebar.active {
            transform: translateX(0);
        }
        .model-select-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        .model-option {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .model-option:hover {
            background: #f0f5ff;
        }
        .model-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }
        .model-name {
            font-size: 18px;
            font-weight: 500;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        .overlay.active {
            display: block;
        }
        .add-agent.disabled {
            background: #b0c4de;
            cursor: not-allowed;
        }
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 400px;
            max-width: 700px;
        }
        .chat-box {
            width: 100%;
            min-height: 350px;
            max-height: 60vh;
            background: rgba(240,248,255,0.98); /* Êõ¥ÊµÖÁöÑËìùÁôΩËâ≤ */
            border-radius: 24px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
            padding: 32px 24px 24px 24px; /* È°∂ÈÉ®‰∏çÂÜçÁïôÁ©∫Èó¥ */
            overflow-y: auto;
            margin-bottom: 32px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: relative;
        }
        .agent-title {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            font-weight: bold;
            color: #2266bb;
            background: linear-gradient(90deg, #e6f0fa 60%, #dbeafe 100%);
            border-radius: 12px 12px 12px 0;
            padding: 4px 18px 4px 16px;
            box-shadow: 0 2px 8px rgba(58,141,222,0.08);
            z-index: 100;
            letter-spacing: 1px;
            pointer-events: none;
        }
        .message {
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
        }
        .message.user {
            align-items: flex-end;
        }
        .message.ai {
            align-items: flex-start;
        }
        .message-content {
            background: #e6f0fa;
            color: #222;
            border-radius: 16px;
            padding: 10px 16px;
            max-width: 80%;
            word-break: break-word;
        }
        .message.user .message-content {
            background: #3a8dde;
            color: #fff;
        }
        
        .message.system {
            width: 100%;
            margin: 10px 0;
            padding: 5px 0;
            text-align: center;
        }
        .input-area {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            position: absolute;
            bottom: 32px;
            left: 0;
        }
        .input-box {
            width: 60%;
            min-width: 320px;
            max-width: 600px;
            border-radius: 24px;
            border: none;
            padding: 16px 20px;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            outline: none;
            resize: none;
            background: #fff;
            transition: box-shadow 0.2s;
        }
        .input-box:focus {
            box-shadow: 0 0 0 2px #3a8dde;
        }
        
        /* ËÆ®ËÆ∫‰∏≠ÊÇ¨ÊµÆÊ°ÜÊ†∑Âºè */
        .discussion-panel {
            position: fixed;
            bottom: 160px; /* Â∞ÜÊÇ¨ÊµÆÊ°ÜÂæÄ‰∏äÁßªÂä® */
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 12px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 16px;
            z-index: 1000;
            display: none;
        }
        
        .discussion-panel.active {
            display: flex;
        }
        
        .discussion-status {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }
        
        .pause-button, .stop-button {
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
            font-family: Arial, sans-serif;
        }
        
        .pause-button {
            background: #ffa940;
        }
        
        .pause-button:hover {
            background: #ffb366;
        }
        
        .pause-button.paused {
            background: #52c41a;
        }
        
        .pause-button.paused:hover {
            background: #73d13d;
        }
        
        .stop-button {
            background: #ff4d4f;
        }
        
        .stop-button:hover {
            background: #ff7875;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="model-select-sidebar" id="modelSelectSidebar">
            <div class="model-select-header">
                <h2>ÈÄâÊã©AIÊ®°Âûã</h2>
                <button class="close-btn" id="closeModelSelect">&times;</button>
            </div>
            <div class="model-option" data-model="Zhipu" onclick="selectModel('Zhipu')">
                <img src="img/Zhipu.png" class="model-icon" alt="Zhipu">
                <span class="model-name">Zhipu AI</span>
            </div>
            <div class="model-option" data-model="Spark" onclick="selectModel('Spark')">
                <img src="img/Spark.png" class="model-icon" alt="Spark">
                <span class="model-name">Spark AI</span>
            </div>
        </div>
        <div class="overlay" id="overlay"></div>
        <div class="sidebar" id="sidebar">
            <!-- agent icons & add button -->
        </div>
        <div class="chat-area">
            <div class="chat-box" id="chatBox">
                <!-- chat messages -->
            </div>
        </div>
        <div class="input-area">
            <textarea id="inputBox" class="input-box" rows="2" placeholder="ËæìÂÖ•ÂÜÖÂÆπÔºåShift+EnterÊç¢Ë°åÔºåEnterÂèëÈÄÅ..."></textarea>
        </div>
        
        <!-- ËÆ®ËÆ∫‰∏≠ÊÇ¨ÊµÆÊ°Ü -->
        <div class="discussion-panel" id="discussionPanel">
            <button class="pause-button" id="pauseDiscussion">||</button>
            <div class="discussion-status">ËÆ®ËÆ∫‰∏≠...</div>
            <button class="stop-button" id="stopDiscussion">‚ñ†</button>
        </div>
    </div>
    <script>
        // agent ÁÆ°ÁêÜ
        let agents = [createAgent(1)];
        let selectedAgent = 1;
        const maxAgents = 3;

        function createAgent(id, model) {
            return {
                id,
                model: model || 'Zhipu', // ÈªòËÆ§ZhipuÊ®°Âûã
                messages: []
            };
        }

        function selectModel(model) {
            if (agents.length < maxAgents) {
                const newId = (agents.length > 0 ? Math.max(...agents.map(a=>parseInt(a.id)))+1 : 1).toString();
                agents.push(createAgent(newId, model));
                selectedAgent = newId;
                renderSidebar();
                renderChat();
                // ÈöêËóèÊ®°ÂûãÈÄâÊã©‰æßËæπÊ†è
                document.getElementById('modelSelectSidebar').classList.remove('active');
                document.getElementById('overlay').classList.remove('active');
                // ÈÄöÁü•ÂêéÁ´ØÂàõÂª∫agent
                fetch('http://127.0.0.1:5000/agent', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: newId.toString(), model: model})
                })
                .catch(err => console.error('ÂàõÂª∫agentÂ§±Ë¥•:', err));
                // ÊèêÁ§∫AgentÂ∑≤Âä†ÂÖ•ËÅäÂ§©
                addSystemMessage(`Agent ${newId} Â∑≤Âä†ÂÖ•ËÅäÂ§©`);
            }
        }

        function renderSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.innerHTML = '';
            agents.forEach((agent, idx) => {
                const icon = document.createElement('div');
                icon.className = 'agent-icon' + (selectedAgent === agent.id ? ' selected' : '');
                icon.title = `AI Agent ${agent.id}`;
                const model = agent.model || 'Zhipu';
                icon.innerHTML = `<img src="img/${model}.png" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">`;
                icon.onclick = () => { selectedAgent = agent.id; renderSidebar(); renderChat(); };

                // Âà†Èô§ÊåâÈíÆ
                if (agents.length > 1) {
                    const remove = document.createElement('div');
                    remove.className = 'remove-agent';
                    remove.innerHTML = '‚àí';
                    remove.onclick = (e) => {
                        e.stopPropagation();
                        removeAgent(agent.id);
                    };
                    icon.appendChild(remove);
                }
                sidebar.appendChild(icon);
            });
            // add agent
            const addBtn = document.createElement('div');
            addBtn.className = 'add-agent' + (agents.length >= maxAgents ? ' disabled' : '');
            addBtn.innerHTML = '+';
            addBtn.title = agents.length >= maxAgents ? 'ÊúÄÂ§ö3‰∏™AI Agent' : 'Ê∑ªÂä†AI Agent';
            addBtn.onclick = () => {
                if (agents.length < maxAgents) {
                    document.getElementById('modelSelectSidebar').classList.add('active');
                    document.getElementById('overlay').classList.add('active');
                }
            };

            // ÂÖ≥Èó≠Ê®°ÂûãÈÄâÊã©‰æßËæπÊ†è
            document.getElementById('closeModelSelect').onclick = () => {
                document.getElementById('modelSelectSidebar').classList.remove('active');
                document.getElementById('overlay').classList.remove('active');
            };

            document.getElementById('overlay').onclick = () => {
                document.getElementById('modelSelectSidebar').classList.remove('active');
                document.getElementById('overlay').classList.remove('active');
            };
            sidebar.appendChild(addBtn);
        }

        function removeAgent(id) {
            if (agents.length <= 1) return;
            const idx = agents.findIndex(a => a.id === id);
            
            // ‰øùÂ≠òË¢´Âà†Èô§agentÁöÑÊ∂àÊÅØ
            const removedAgent = agents[idx];
            const removedAgentModel = removedAgent.model;
            
            // ‰ªéagentsÊï∞ÁªÑ‰∏≠ÁßªÈô§agentÔºå‰ΩÜ‰øùÁïôÂÖ∂Ê∂àÊÅØ
            agents.splice(idx, 1);
            
            if (selectedAgent === id) {
                selectedAgent = agents[0].id;
            }
            
            renderSidebar();
            renderChat();
            
            // ÊèêÁ§∫AgentÂ∑≤ÈÄÄÂá∫ËÅäÂ§©
            addSystemMessage(`Agent ${id} Â∑≤ÈÄÄÂá∫ËÅäÂ§©`);
        }

        // Â≠òÂÇ®ÊâÄÊúâÊ∂àÊÅØÁöÑÂÖ®Â±ÄÊï∞ÁªÑÔºåÂåÖÊã¨Â∑≤Âà†Èô§agentÁöÑÊ∂àÊÅØ
        let allMessages = [];
        
        function renderChat() {
            const chatBox = document.getElementById('chatBox');
            chatBox.innerHTML = '';
            
            // ÊåâÊó∂Èó¥È°∫Â∫èÊ∏≤ÊüìÊâÄÊúâÊ∂àÊÅØ
            allMessages.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'message ' + msg.role;
                
                if (msg.role === 'user') {
                    msgDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <span style="font-size: 12px; color: #666;">Áî®Êà∑</span>
                        </div>
                        <div class="message-content" style="max-width: 100%; width: fit-content;">${msg.content.replace(/\n/g, '<br>')}</div>
                    `;
                } else {
                    msgDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <img src="img/${msg.model}.png" style="width: 24px; height: 24px; border-radius: 50%;">
                            <span style="font-size: 12px; color: #666;">Agent ${msg.agentId}</span>
                        </div>
                        <div class="message-content" style="max-width: 100%; width: fit-content;">${msg.content.replace(/\n/g, '<br>')}</div>
                    `;
                }
                chatBox.appendChild(msgDiv);
            });
            
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addSystemMessage(content) {
            const chatBox = document.getElementById('chatBox');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message system';
            msgDiv.innerHTML = `<div style="text-align: center; color: #666; font-size: 12px;">${content}</div>`;
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // ËæìÂÖ•Ê°Ü‰∫ã‰ª∂
        const inputBox = document.getElementById('inputBox');
        inputBox.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const content = inputBox.value.trim();
                if (content) {
                    sendMessage(content);
                    inputBox.value = '';
                }
            }
        });

        // Ë∑üË∏™ÂΩìÂâçÊòØÂê¶ÊúâËØ∑Ê±ÇÊ≠£Âú®ËøõË°å‰∏≠
        let isRequestInProgress = false;
        
        // Ë∑üË∏™ÂΩìÂâçÊòØÂê¶Âú®ËÆ®ËÆ∫Ê®°Âºè
        let isDiscussionMode = false;
        
        // ËÆ®ËÆ∫IDÔºåÁî®‰∫éÂÅúÊ≠¢ËÆ®ËÆ∫
        let currentDiscussionId = null;
        
        // ÊöÇÂÅúÁä∂ÊÄÅÁÆ°ÁêÜ
        let discussionState = {
            isPaused: false,
            waitingForUser: false,
            pausedAfterAgent: null,
            eventSource: null
        };
        
        
        // Áî®Êà∑ÂèëË®ÄÁä∂ÊÄÅËøΩË∏™
        let userInterventionState = {
            pending: false,
            lastMessage: null,
            targetAgent: null
        };
        
        // ÊòæÁ§∫ËÆ®ËÆ∫‰∏≠ÊÇ¨ÊµÆÊ°Ü
        function showDiscussionPanel() {
            document.getElementById('discussionPanel').classList.add('active');
            isDiscussionMode = true;
        }
        
        // ÈöêËóèËÆ®ËÆ∫‰∏≠ÊÇ¨ÊµÆÊ°Ü
        function hideDiscussionPanel() {
            document.getElementById('discussionPanel').classList.remove('active');
            isDiscussionMode = false;
        }
        
        // ÂÅúÊ≠¢ËÆ®ËÆ∫
        function stopDiscussion() {
            if (currentDiscussionId) {
                // Á´ãÂç≥ÁßªÈô§ÊÄùËÄÉÊ∞îÊ≥°ÂíåËÆ®ËÆ∫Èù¢Êùø
                removeThinkingBubble();
                hideDiscussionPanel();
                
                // Á´ãÂç≥ÈáçÁΩÆËØ∑Ê±ÇÁä∂ÊÄÅÔºåÂÖÅËÆ∏Áî®Êà∑ÁªßÁª≠ËæìÂÖ•
                isRequestInProgress = false;
                
                // Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØ
                addSystemMessage('ËÆ®ËÆ∫Â∑≤ÂÅúÊ≠¢');
                
                // ÈÄöÁü•ÊúçÂä°Âô®ÂÅúÊ≠¢ËÆ®ËÆ∫
                fetch('http://127.0.0.1:5000/stop_discussion', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        discussion_id: currentDiscussionId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('ÂÅúÊ≠¢ËÆ®ËÆ∫ÂìçÂ∫î:', data);
                })
                .catch(err => {
                    console.error('ÂÅúÊ≠¢ËÆ®ËÆ∫Â§±Ë¥•:', err);
                });
                
                // ÈáçÁΩÆËÆ®ËÆ∫ID
                currentDiscussionId = null;
            }
        }
        
        function sendMessage(content) {
            // Â¶ÇÊûúËÆ®ËÆ∫Â§Ñ‰∫éÊöÇÂÅúÁä∂ÊÄÅ‰∏îÁ≠âÂæÖÁî®Êà∑ÂèëË®ÄÔºåÂàôÂ§ÑÁêÜÁî®Êà∑ÊèíÂÖ•ÂèëË®Ä
            if (discussionState.isPaused && discussionState.waitingForUser) {
                sendUserIntervention(content);
                return;
            }
            
            // Â¶ÇÊûúÂ∑≤ÁªèÊúâËØ∑Ê±ÇÊ≠£Âú®ËøõË°å‰∏≠Ôºå‰∏çË¶ÅÂèëÈÄÅÊñ∞ËØ∑Ê±Ç
            if (isRequestInProgress && !discussionState.waitingForUser) {
                console.log('Â∑≤ÊúâËØ∑Ê±ÇÊ≠£Âú®ËøõË°å‰∏≠ÔºåËØ∑Á≠âÂæÖ...');
                return;
            }
            
            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØÂà∞ÂÖ®Â±ÄÊ∂àÊÅØÊï∞ÁªÑ
            allMessages.push({
                role: 'user',
                content: content,
                timestamp: Date.now()
            });
            
            // Á´ãÂç≥ÊòæÁ§∫Áî®Êà∑ËæìÂÖ•
            const currentAgent = agents.find(agent => agent.id === selectedAgent);
            if (currentAgent) {
                currentAgent.messages.push({
                    role: 'user',
                    content: content
                });
                renderChat();
            }

            // Ê†áËÆ∞ËØ∑Ê±ÇÂºÄÂßã
            isRequestInProgress = true;
            
            // Âçïagent‰ΩøÁî®ÊµÅÂºèËæìÂá∫ÔºåÂ§öagent‰ΩøÁî®ÂéüÊúâÊñπÂºè
            if (agents.length === 1) {
                sendStreamMessage(content);
            } else {
                sendNormalMessage(content);
            }
        }
        
        function sendStreamMessage(content) {
            const currentAgent = agents.find(agent => agent.id === selectedAgent);
            
            // ÂÖàÊòæÁ§∫ÊÄùËÄÉÂä†ËΩΩÊïàÊûú
            showThinkingBubble(currentAgent.id, currentAgent.model);
            
            // ‰ΩøÁî®EventSourceËøõË°åÊµÅÂºèÈÄö‰ø°
            const eventSource = new EventSource('http://127.0.0.1:5000/chat_stream?' + new URLSearchParams({
                agent_ids: JSON.stringify([currentAgent.id]),
                message: content,
                current_agent: selectedAgent,
                enable_discussion: 'false'
            }));
            
            let fullContent = '';
            let streamBubble = null;
            
            eventSource.onopen = function(event) {
                console.log('EventSourceËøûÊé•Â∑≤ÊâìÂºÄ');
            };
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log('Êî∂Âà∞ÊµÅÂºèÊï∞ÊçÆ:', data);
                    
                    if (data.type === 'start') {
                        console.log('ÂºÄÂßãÊµÅÂºèÊé•Êî∂:', data);
                        // ÁßªÈô§ÊÄùËÄÉÊ∞îÊ≥°ÔºåÂàõÂª∫ÊµÅÂºèÊ∞îÊ≥°
                        removeThinkingBubble();
                        streamBubble = createStreamBubble(currentAgent.id, currentAgent.model);
                    } else if (data.type === 'content') {
                        fullContent += data.content;
                        if (streamBubble) {
                            updateStreamBubble(streamBubble, fullContent);
                        }
                    } else if (data.type === 'end') {
                        console.log('ÊµÅÂºèÊé•Êî∂ÂÆåÊàê');
                        if (streamBubble) {
                            finalizeStreamBubble(streamBubble, data.full_content || fullContent);
                        }
                        
                        // Ê∑ªÂä†Âà∞ÂÖ®Â±ÄÊ∂àÊÅØÊï∞ÁªÑ
                        allMessages.push({
                            role: 'assistant',
                            content: data.full_content || fullContent,
                            agentId: currentAgent.id,
                            model: currentAgent.model,
                            timestamp: Date.now()
                        });
                        
                        // ÂêåÊó∂Ê∑ªÂä†Âà∞ÂØπÂ∫îagentÁöÑÊ∂àÊÅØÊï∞ÁªÑ
                        currentAgent.messages.push({
                            role: 'assistant',
                            content: data.full_content || fullContent
                        });
                        
                        eventSource.close();
                        isRequestInProgress = false;
                    } else if (data.type === 'error') {
                        console.error('ÊµÅÂºèÊé•Êî∂ÈîôËØØ:', data.content);
                        if (streamBubble) {
                            finalizeStreamBubble(streamBubble, data.content);
                        } else {
                            removeThinkingBubble();
                        }
                        eventSource.close();
                        isRequestInProgress = false;
                    }
                } catch (e) {
                    console.error('Ëß£ÊûêÊµÅÂºèÊï∞ÊçÆÂ§±Ë¥•:', e, 'Raw data:', event.data);
                }
            };
            
            eventSource.onerror = function(event) {
                console.error('EventSourceÈîôËØØ:', event);
                removeThinkingBubble();
                
                // Â¶ÇÊûúEventSourceÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞fetchÊñπÂºè
                console.log('EventSourceÂ§±Ë¥•ÔºåÂ∞ùËØïfetchÊñπÂºè...');
                sendStreamMessageFallback(content, currentAgent);
            };
        }
        
        // Â§áÁî®ÁöÑfetchÊµÅÂºèÊñπÊ≥ï
        function sendStreamMessageFallback(content, currentAgent) {
            // ÂàõÂª∫Êñ∞ÁöÑÊµÅÂºèÊ∞îÊ≥°
            const streamBubble = createStreamBubble(currentAgent.id, currentAgent.model);
            
            fetch('http://127.0.0.1:5000/chat_stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'text/event-stream'
                },
                body: JSON.stringify({
                    agent_ids: [currentAgent.id],
                    message: content,
                    current_agent: selectedAgent,
                    enable_discussion: false
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullContent = '';
                let buffer = '';
                let streamStarted = false;
                
                function readStream() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            console.log('FetchÊµÅÂºèÊé•Êî∂ÂÆåÊàê');
                            if (streamBubble && fullContent) {
                                finalizeStreamBubble(streamBubble, fullContent);
                                
                                // Ê∑ªÂä†Âà∞ÂÖ®Â±ÄÊ∂àÊÅØÊï∞ÁªÑ
                                allMessages.push({
                                    role: 'assistant',
                                    content: fullContent,
                                    agentId: currentAgent.id,
                                    model: currentAgent.model,
                                    timestamp: Date.now()
                                });
                                
                                // ÂêåÊó∂Ê∑ªÂä†Âà∞ÂØπÂ∫îagentÁöÑÊ∂àÊÅØÊï∞ÁªÑ
                                currentAgent.messages.push({
                                    role: 'assistant',
                                    content: fullContent
                                });
                            }
                            isRequestInProgress = false;
                            return;
                        }
                        
                        const chunk = decoder.decode(value, { stream: true });
                        buffer += chunk;
                        
                        // ÊåâË°åÂàÜÂâ≤Â§ÑÁêÜ
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || ''; // ‰øùÁïôÊúÄÂêé‰∏Ä‰∏™‰∏çÂÆåÊï¥ÁöÑË°å
                        
                        for (const line of lines) {
                            if (line.trim() === '') continue;
                            
                            if (line.startsWith('data: ')) {
                                try {
                                    const jsonStr = line.slice(6).trim();
                                    if (jsonStr === '') continue;
                                    
                                    const data = JSON.parse(jsonStr);
                                    console.log('FetchÊî∂Âà∞ÊµÅÂºèÊï∞ÊçÆ:', data);
                                    
                                    if (data.type === 'start') {
                                        console.log('FetchÂºÄÂßãÊµÅÂºèÊé•Êî∂:', data);
                                        streamStarted = true;
                                    } else if (data.type === 'content') {
                                        fullContent += data.content;
                                        if (streamBubble) {
                                            updateStreamBubble(streamBubble, fullContent);
                                        }
                                    } else if (data.type === 'end') {
                                        console.log('FetchÊµÅÂºèÊé•Êî∂ÂÆåÊàê');
                                        if (streamBubble) {
                                            finalizeStreamBubble(streamBubble, data.full_content || fullContent);
                                        }
                                        
                                        // Ê∑ªÂä†Âà∞ÂÖ®Â±ÄÊ∂àÊÅØÊï∞ÁªÑ
                                        allMessages.push({
                                            role: 'assistant',
                                            content: data.full_content || fullContent,
                                            agentId: currentAgent.id,
                                            model: currentAgent.model,
                                            timestamp: Date.now()
                                        });
                                        
                                        // ÂêåÊó∂Ê∑ªÂä†Âà∞ÂØπÂ∫îagentÁöÑÊ∂àÊÅØÊï∞ÁªÑ
                                        currentAgent.messages.push({
                                            role: 'assistant',
                                            content: data.full_content || fullContent
                                        });
                                        
                                        isRequestInProgress = false;
                                        return;
                                    } else if (data.type === 'error') {
                                        console.error('FetchÊµÅÂºèÊé•Êî∂ÈîôËØØ:', data.content);
                                        if (streamBubble) {
                                            finalizeStreamBubble(streamBubble, data.content);
                                        }
                                        isRequestInProgress = false;
                                        return;
                                    }
                                } catch (e) {
                                    console.error('FetchËß£ÊûêÊµÅÂºèÊï∞ÊçÆÂ§±Ë¥•:', e, 'Line:', line);
                                }
                            }
                        }
                        
                        return readStream();
                    });
                }
                
                return readStream();
            })
            .catch(error => {
                console.error('FetchÊµÅÂºèËØ∑Ê±ÇÂ§±Ë¥•:', error);
                if (streamBubble) {
                    finalizeStreamBubble(streamBubble, '[ËøûÊé•ÈîôËØØ]');
                }
                isRequestInProgress = false;
            });
        }
        
        function sendNormalMessage(content) {
            const currentAgent = agents.find(agent => agent.id === selectedAgent);
            
            // Â§öagent‰ΩøÁî®ÊµÅÂºèËÆ®ËÆ∫
            if (agents.length > 1) {
                sendStreamDiscussion(content);
            } else {
                // Âçïagent‰ΩøÁî®ÂéüÊúâÈÄªËæë
                // ÊòæÁ§∫AIÊ≠£Âú®ÊÄùËÄÉÁöÑÂä†ËΩΩÂä®Áîª
                showThinkingBubble(currentAgent.id, currentAgent.model);
                
                // ÂèëÈÄÅÊ∂àÊÅØÂà∞ÂêéÁ´Ø
                fetch('http://127.0.0.1:5000/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        agent_ids: agents.map(a => a.id),
                        message: content,
                        current_agent: selectedAgent,
                        enable_discussion: false
                    })
                })
                .then(response => {
                    console.log('Êî∂Âà∞ÊúçÂä°Âô®ÂìçÂ∫î:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Ëß£ÊûêÂìçÂ∫îÊï∞ÊçÆ:', data);
                    
                    // ÁßªÈô§ÊÄùËÄÉ‰∏≠ÁöÑÊ∞îÊ≥°
                    removeThinkingBubble();
                    
                    // Ê†áËÆ∞ËØ∑Ê±ÇÁªìÊùü
                    isRequestInProgress = false;
                    
                    // Ê∏≤ÊüìÂõûÂ§ç
                    if (data.discussion && Array.isArray(data.discussion)) {
                        data.discussion.forEach(reply => {
                            if (reply.type !== 'discussion_status' && reply.type !== 'user_message') {
                                // Ê∑ªÂä†Âà∞ÂÖ®Â±ÄÊ∂àÊÅØÊï∞ÁªÑ
                                allMessages.push({
                                    role: 'assistant',
                                    content: reply.content,
                                    agentId: reply.agent_id,
                                    model: reply.avatar.includes('Spark') ? 'Spark' : 'Zhipu',
                                    timestamp: Date.now()
                                });
                                
                                // ÂêåÊó∂Ê∑ªÂä†Âà∞ÂØπÂ∫îagentÁöÑÊ∂àÊÅØÊï∞ÁªÑ
                                const agent = agents.find(a => a.id.toString() === reply.agent_id);
                                if (agent) {
                                    agent.messages.push({
                                        role: 'assistant',
                                        content: reply.content
                                    });
                                }
                            }
                        });
                        renderChat();
                    } else if (data.error) {
                        console.error('ÊúçÂä°Âô®ËøîÂõûÈîôËØØ:', data.error);
                        // ‰∏çÊòæÁ§∫ÈîôËØØÊ∂àÊÅØÔºåÂè™Âú®ÊéßÂà∂Âè∞ËÆ∞ÂΩï
                    }
                })
                .catch(err => {
                    console.error('ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•:', err);
                    
                    // ÁßªÈô§ÊÄùËÄÉ‰∏≠ÁöÑÊ∞îÊ≥°
                    removeThinkingBubble();
                    
                    // Ê†áËÆ∞ËØ∑Ê±ÇÁªìÊùü
                    isRequestInProgress = false;
                    
                    // ‰∏çÊòæÁ§∫‰ªª‰ΩïÈîôËØØÊ∂àÊÅØÔºåÂè™Âú®ÊéßÂà∂Âè∞ËÆ∞ÂΩï
                });
            }
        }
        
        // ÊµÅÂºèËÆ®ËÆ∫Â§ÑÁêÜÂáΩÊï∞
        function sendStreamDiscussion(content) {
            // ‰ΩøÁî®EventSourceËøõË°åÊµÅÂºèËÆ®ËÆ∫
            const eventSource = new EventSource('http://127.0.0.1:5000/chat_stream?' + new URLSearchParams({
                agent_ids: JSON.stringify(agents.map(a => a.id)),
                message: content,
                current_agent: selectedAgent,
                enable_discussion: 'true'
            }));
            
            let currentStreamBubble = null;
            let currentAgentContent = '';
            let discussionStarted = false;
            
            eventSource.onopen = function(event) {
                console.log('ËÆ®ËÆ∫EventSourceËøûÊé•Â∑≤ÊâìÂºÄ');
            };
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log('Êî∂Âà∞ËÆ®ËÆ∫ÊµÅÂºèÊï∞ÊçÆ:', data);
                    
                    if (data.type === 'start') {
                        console.log('ÂºÄÂßãÊµÅÂºèÂ§ÑÁêÜ:', data);
                        // ‰øùÂ≠òdiscussion_idÔºåÁî®‰∫éÊöÇÂÅú/ÂÅúÊ≠¢ÂäüËÉΩ
                        if (data.discussion_id) {
                            currentDiscussionId = data.discussion_id;
                            console.log('Â∑≤‰øùÂ≠òdiscussion_id:', currentDiscussionId);
                        }
                        
                        // Âè™ÊúâÂú®ÁúüÊ≠£ÁöÑÂ§çÊùÇÈóÆÈ¢òËÆ®ËÆ∫Ê®°Âºè‰∏ãÊâçÊòæÁ§∫ÊÇ¨ÊµÆÁ™ó
                        if (data.mode === 'discussion' && agents.length > 1) {
                            discussionStarted = true;
                            showDiscussionPanel();
                            console.log('ÊòæÁ§∫ËÆ®ËÆ∫ÊÇ¨ÊµÆÊ°Ü - Â§çÊùÇÈóÆÈ¢òÊ®°Âºè');
                        } else if (data.mode === 'simple') {
                            console.log('ÁÆÄÂçïÈóÆÈ¢òÊ®°Âºè - ‰∏çÊòæÁ§∫ËÆ®ËÆ∫ÊÇ¨ÊµÆÊ°Ü');
                            // ÁÆÄÂçïÈóÆÈ¢òÊ®°ÂºèÔºå‰∏çÊòæÁ§∫ÊÇ¨ÊµÆÊ°ÜÔºåÁ≠âÂæÖagentÁõ¥Êé•ÂõûÁ≠î
                        }
                    } else if (data.type === 'framework_start') {
                        // ÊòæÁ§∫Ê°ÜÊû∂ÂàõÂª∫Áä∂ÊÄÅ
                        addSystemMessage(data.content);
                    } else if (data.type === 'framework_complete') {
                        // Ê°ÜÊû∂ÂàõÂª∫ÂÆåÊàê
                        addSystemMessage('ËÆ®ËÆ∫Ê°ÜÊû∂ÂàõÂª∫ÂÆåÊàê');
                    } else if (data.type === 'agent_thinking') {
                        // AgentÂºÄÂßãÊÄùËÄÉ
                        removeThinkingBubble(); // ÁßªÈô§‰πãÂâçÁöÑÊÄùËÄÉÊ∞îÊ≥°
                        showThinkingBubble(data.agent_id, data.model);
                        addSystemMessage(`Agent ${data.agent_id} Ê≠£Âú®ÊÄùËÄÉ: ${data.question}`);
                    } else if (data.type === 'agent_content_chunk') {
                        // ÊµÅÂºèÂÜÖÂÆπÂùó
                        if (!currentStreamBubble || currentStreamBubble.dataset.agentId !== data.agent_id) {
                            // ÂàõÂª∫Êñ∞ÁöÑÊµÅÂºèÊ∞îÊ≥°
                            removeThinkingBubble();
                            currentStreamBubble = createStreamBubble(data.agent_id, data.model);
                            currentStreamBubble.dataset.agentId = data.agent_id;
                            currentAgentContent = '';
                        }
                        
                        currentAgentContent += data.content;
                        updateStreamBubble(currentStreamBubble, currentAgentContent);
                    } else if (data.type === 'agent_content_complete') {
                        // ÂÆåÊï¥ÂÜÖÂÆπÔºàÈùûÊµÅÂºèagentÔºâ
                        removeThinkingBubble();
                        currentStreamBubble = createStreamBubble(data.agent_id, data.model);
                        finalizeStreamBubble(currentStreamBubble, data.content);
                        
                        // Ê∑ªÂä†Âà∞Ê∂àÊÅØÊï∞ÁªÑ
                        allMessages.push({
                            role: 'assistant',
                            content: data.content,
                            agentId: data.agent_id,
                            model: data.model,
                            timestamp: Date.now()
                        });
                        
                        currentStreamBubble = null;
                    } else if (data.type === 'agent_complete') {
                        // AgentÂÆåÊàêÂõûÁ≠î
                        if (currentStreamBubble) {
                            finalizeStreamBubble(currentStreamBubble, currentAgentContent);
                            
                            // Ê∑ªÂä†Âà∞Ê∂àÊÅØÊï∞ÁªÑ
                            allMessages.push({
                                role: 'assistant',
                                content: currentAgentContent,
                                agentId: data.agent_id,
                                model: data.model,
                                timestamp: Date.now()
                            });
                            
                            currentStreamBubble = null;
                            currentAgentContent = '';
                        }
                    } else if (data.type === 'agent_message') {
                        // ÁÆÄÂçïÂõûÂ§çÔºàÈùûËÆ®ËÆ∫Ê®°ÂºèÔºâ
                        removeThinkingBubble();
                        
                        allMessages.push({
                            role: 'assistant',
                            content: data.content,
                            agentId: data.agent_id,
                            model: data.model,
                            timestamp: Date.now()
                        });
                        renderChat();
                    } else if (data.type === 'summary_start') {
                        addSystemMessage(data.content);
                    } else if (data.type === 'summary_complete') {
                        addSystemMessage('ËÆ®ËÆ∫ÊÄªÁªìÂÆåÊàê');
                        
                        allMessages.push({
                            role: 'assistant',
                            content: data.content,
                            agentId: data.message.agent_id,
                            model: data.message.avatar.includes('Spark') ? 'Spark' : 'Zhipu',
                            timestamp: Date.now()
                        });
                        renderChat();
                    } else if (data.type === 'discussion_complete') {
                        console.log('ÊµÅÂºèËÆ®ËÆ∫ÂÆåÊàê');
                        hideDiscussionPanel();
                        removeThinkingBubble();
                        resetInputToNormal(); // ÈáçÁΩÆËæìÂÖ•Ê°ÜÁä∂ÊÄÅ
                        eventSource.close();
                    } else if (data.type === 'discussion_stopped') {
                        addSystemMessage(data.content);
                        hideDiscussionPanel();
                        removeThinkingBubble();
                        resetInputToNormal(); // ÈáçÁΩÆËæìÂÖ•Ê°ÜÁä∂ÊÄÅ
                        eventSource.close();
                        // Ê∏ÖÈô§Ë∂ÖÊó∂ÂÆöÊó∂Âô®
                        if (connectionTimeout) {
                            clearTimeout(connectionTimeout);
                            connectionTimeout = null;
                        }
                    } else if (data.type === 'error') {
                        console.error('ËÆ®ËÆ∫ÊµÅÂºèÊé•Êî∂ÈîôËØØ:', data.content);
                        addSystemMessage(`ÈîôËØØ: ${data.content}`);
                        hideDiscussionPanel();
                        removeThinkingBubble();
                        resetInputToNormal(); // ÈáçÁΩÆËæìÂÖ•Ê°ÜÁä∂ÊÄÅ
                        eventSource.close();
                        // Ê∏ÖÈô§Ë∂ÖÊó∂ÂÆöÊó∂Âô®
                        if (connectionTimeout) {
                            clearTimeout(connectionTimeout);
                            connectionTimeout = null;
                        }
                    } else if (data.type === 'agent_selected') {
                        // ÊòæÁ§∫agentÊô∫ËÉΩÈÄâÊã©Ê∂àÊÅØ
                        addSystemMessage(`üì¢ ${data.content} (${data.reason})`);
                        console.log('AgentÊô∫ËÉΩÈÄâÊã©:', data);
                    }
                } catch (e) {
                    console.error('Ëß£ÊûêËÆ®ËÆ∫ÊµÅÂºèÊï∞ÊçÆÂ§±Ë¥•:', e, 'Raw data:', event.data);
                }
            };
            
            eventSource.onerror = function(event) {
                console.error('ËÆ®ËÆ∫EventSourceÈîôËØØ:', event);
                // ÁßªÈô§ÈîôËØØÊèêÁ§∫ÔºåÁõ¥Êé•Â§ÑÁêÜ
                hideDiscussionPanel();
                removeThinkingBubble();
                eventSource.close();
                isRequestInProgress = false;
                
                // ‰∏çÊòæÁ§∫ÈîôËØØÊ∂àÊÅØÔºåÈùôÈªòÂ§ÑÁêÜ
                console.log('EventSourceËøûÊé•‰∏≠Êñ≠ÔºåÂ∑≤ÈùôÈªòÂ§ÑÁêÜ');
            };
            
            // ‰øùÂ≠òÂΩìÂâçËÆ®ËÆ∫ÁöÑEventSource‰ª•‰æøÂÅúÊ≠¢
            currentDiscussionEventSource = eventSource;
        }
        
        // ËΩÆËØ¢ËÆ®ËÆ∫Áä∂ÊÄÅ
        function pollDiscussionStatus(discussionId) {
            if (!isDiscussionMode) return; // Â¶ÇÊûú‰∏çÂÜçÊòØËÆ®ËÆ∫Ê®°ÂºèÔºåÂÅúÊ≠¢ËΩÆËØ¢
            
            fetch(`http://127.0.0.1:5000/discussion_status/${discussionId}`)
            .then(response => response.json())
            .then(data => {
                console.log('ËÆ®ËÆ∫Áä∂ÊÄÅ:', data);
                
                // Â¶ÇÊûúÊúâÊñ∞Ê∂àÊÅØÔºåÊ∑ªÂä†Âà∞ËÅäÂ§©Ê°Ü
                if (data.new_messages && Array.isArray(data.new_messages) && data.new_messages.length > 0) {
                    // ÁßªÈô§‰πãÂâçÁöÑÊÄùËÄÉÊ∞îÊ≥°ÔºàÂ¶ÇÊûúÊúâÔºâ
                    removeThinkingBubble();
                    
                    data.new_messages.forEach(msg => {
                        // Ê∑ªÂä†Âà∞ÂÖ®Â±ÄÊ∂àÊÅØÊï∞ÁªÑ
                        allMessages.push({
                            role: 'assistant',
                            content: msg.content,
                            agentId: msg.agent_id,
                            model: msg.avatar.includes('Spark') ? 'Spark' : 'Zhipu',
                            timestamp: Date.now()
                        });
                        
                        // ÂêåÊó∂Ê∑ªÂä†Âà∞ÂØπÂ∫îagentÁöÑÊ∂àÊÅØÊï∞ÁªÑ
                        const agent = agents.find(a => a.id.toString() === msg.agent_id);
                        if (agent) {
                            agent.messages.push({
                                role: 'assistant',
                                content: msg.content
                            });
                        }
                    });
                    
                    // Á°Æ‰øùÊ∏≤ÊüìËÅäÂ§©ÂÜÖÂÆπ
                    renderChat();
                    
                    // ÊòæÁ§∫‰∏ã‰∏Ä‰∏™agentÁöÑÊÄùËÄÉÊ∞îÊ≥°
                    if (data.next_agent_id) {
                        const nextAgent = agents.find(a => a.id.toString() === data.next_agent_id);
                        if (nextAgent) {
                            showThinkingBubble(data.next_agent_id, nextAgent.model);
                        }
                    }
                }
                
                // Â¶ÇÊûúËÆ®ËÆ∫Â∑≤ÂÆåÊàêÔºåÈöêËóèËÆ®ËÆ∫Èù¢Êùø
                if (data.status === 'completed') {
                    hideDiscussionPanel();
                    removeThinkingBubble(); // Á°Æ‰øùÁßªÈô§ÊâÄÊúâÊÄùËÄÉÊ∞îÊ≥°
                    isRequestInProgress = false;
                    
                    // Á°Æ‰øùÊúÄÂêé‰∏ÄÊ¨°Ê∏≤ÊüìËÅäÂ§©ÂÜÖÂÆπ
                    renderChat();
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâÊÄùËÄÉÊ∞îÊ≥°ÔºåÊòæÁ§∫‰∏Ä‰∏™
                    if (!document.getElementById('thinking-bubble') && data.next_agent_id) {
                        const nextAgent = agents.find(a => a.id.toString() === data.next_agent_id);
                        if (nextAgent) {
                            showThinkingBubble(data.next_agent_id, nextAgent.model);
                        }
                    }
                    
                    // ÁªßÁª≠ËΩÆËØ¢
                    setTimeout(() => pollDiscussionStatus(discussionId), 1000);
                }
            })
            .catch(err => {
                console.error('Ëé∑ÂèñËÆ®ËÆ∫Áä∂ÊÄÅÂ§±Ë¥•:', err);
                // Âá∫ÈîôÊó∂‰πüÁªßÁª≠ËΩÆËØ¢
                setTimeout(() => pollDiscussionStatus(discussionId), 2000);
            });
        }
        
        function showThinkingBubble(agentId, model) {
            const chatBox = document.getElementById('chatBox');
            const thinkingDiv = document.createElement('div');
            thinkingDiv.id = 'thinking-bubble';
            thinkingDiv.className = 'message ai';
            thinkingDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                    <img src="img/${model}.png" style="width: 24px; height: 24px; border-radius: 50%;">
                    <span style="font-size: 12px; color: #666;">Agent ${agentId}</span>
                </div>
                <div class="loading-bubble">
                    <div class="loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            chatBox.appendChild(thinkingDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        function removeThinkingBubble() {
            const thinkingBubble = document.getElementById('thinking-bubble');
            if (thinkingBubble) {
                thinkingBubble.remove();
            }
        }

        // ÊµÅÂºèÊ∂àÊÅØÊ∞îÊ≥°Áõ∏ÂÖ≥ÂáΩÊï∞
        function createStreamBubble(agentId, model) {
            const chatBox = document.getElementById('chatBox');
            const streamDiv = document.createElement('div');
            streamDiv.id = 'stream-bubble';
            streamDiv.className = 'message ai';
            streamDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                    <img src="img/${model}.png" style="width: 24px; height: 24px; border-radius: 50%;">
                    <span style="font-size: 12px; color: #666;">Agent ${agentId}</span>
                </div>
                <div class="message-content" style="max-width: 100%; width: fit-content; position: relative;">
                    <span id="stream-content"></span>
                    <div class="loading-dots" style="display: inline-block; margin-left: 8px;">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            chatBox.appendChild(streamDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            return streamDiv;
        }
        
        function updateStreamBubble(streamBubble, content) {
            const contentSpan = streamBubble.querySelector('#stream-content');
            if (contentSpan) {
                contentSpan.innerHTML = content.replace(/\n/g, '<br>');
                // ÊªöÂä®Âà∞Â∫ïÈÉ®
                const chatBox = document.getElementById('chatBox');
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }
        
        function finalizeStreamBubble(streamBubble, finalContent) {
            const contentDiv = streamBubble.querySelector('.message-content');
            if (contentDiv) {
                // ÁßªÈô§Âä†ËΩΩÂúàÔºåÊòæÁ§∫ÊúÄÁªàÂÜÖÂÆπ
                contentDiv.innerHTML = finalContent.replace(/\n/g, '<br>');
                // ÊªöÂä®Âà∞Â∫ïÈÉ®
                const chatBox = document.getElementById('chatBox');
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }

        // ÂàùÂßãÂåñ
        renderSidebar();
        renderChat();
        
        // ÊöÇÂÅú/ÁªßÁª≠ËÆ®ËÆ∫
        function pauseResumeDiscussion() {
            if (discussionState.isPaused) {
                // ÂΩìÂâçÊòØÊöÇÂÅúÁä∂ÊÄÅÔºåÁÇπÂáªÁªßÁª≠
                resumeDiscussion();
            } else {
                // ÂΩìÂâçÊòØËøêË°åÁä∂ÊÄÅÔºåÁÇπÂáªÊöÇÂÅú
                pauseDiscussion();
            }
        }
        
        function pauseDiscussion() {
            if (!currentDiscussionId) return;
            
            // ÂèëÈÄÅÊöÇÂÅúËØ∑Ê±ÇÂà∞ÊúçÂä°Âô®
            fetch('http://127.0.0.1:5000/pause_discussion', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    discussion_id: currentDiscussionId
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('ÊöÇÂÅúËÆ®ËÆ∫ÂìçÂ∫î:', data);
                discussionState.isPaused = true;
                updatePauseButton();
                updateDiscussionStatus('Â∑≤ÊöÇÂÅúÔºåÁ≠âÂæÖÁî®Êà∑ÂèëË®Ä...');
                
                // ÂêØÁî®ËæìÂÖ•Ê°ÜËÆ©Áî®Êà∑ÂèØ‰ª•ÂèëË®Ä
                enableUserInput();
            })
            .catch(err => {
                console.error('ÊöÇÂÅúËÆ®ËÆ∫Â§±Ë¥•:', err);
            });
        }
        
        function resumeDiscussion() {
            if (!currentDiscussionId) return;
            
            // ÂèëÈÄÅÁªßÁª≠ËØ∑Ê±ÇÂà∞ÊúçÂä°Âô®
            fetch('http://127.0.0.1:5000/resume_discussion', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    discussion_id: currentDiscussionId
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('ÁªßÁª≠ËÆ®ËÆ∫ÂìçÂ∫î:', data);
                discussionState.isPaused = false;
                updatePauseButton();
                updateDiscussionStatus('ËÆ®ËÆ∫‰∏≠...');
                
                // Á¶ÅÁî®ËæìÂÖ•Ê°Ü
                disableUserInput();
            })
            .catch(err => {
                console.error('ÁªßÁª≠ËÆ®ËÆ∫Â§±Ë¥•:', err);
            });
        }
        
        function updatePauseButton() {
            const pauseBtn = document.getElementById('pauseDiscussion');
            if (discussionState.isPaused) {
                pauseBtn.innerHTML = '‚ñ∂';
                pauseBtn.classList.add('paused');
                pauseBtn.title = 'ÁªßÁª≠ËÆ®ËÆ∫';
            } else {
                pauseBtn.innerHTML = '||';
                pauseBtn.classList.remove('paused');
                pauseBtn.title = 'ÊöÇÂÅúËÆ®ËÆ∫';
            }
        }
        
        function updateDiscussionStatus(text) {
            const statusDiv = document.querySelector('.discussion-status');
            if (statusDiv) {
                statusDiv.textContent = text;
            }
        }
        
        function enableUserInput() {
            const inputBox = document.getElementById('inputBox');
            inputBox.disabled = false;
            inputBox.placeholder = 'ËæìÂÖ•ÂÜÖÂÆπÂèÇ‰∏éËÆ®ËÆ∫ÔºåEnterÂèëÈÄÅ...';
            discussionState.waitingForUser = true;
        }
        
        function disableUserInput() {
            const inputBox = document.getElementById('inputBox');
            inputBox.disabled = true;
            inputBox.placeholder = 'ËÆ®ËÆ∫‰∏≠ÔºåËØ∑Á≠âÂæÖ...';
            discussionState.waitingForUser = false;
        }
        
        function resetInputToNormal() {
            const inputBox = document.getElementById('inputBox');
            inputBox.disabled = false;
            inputBox.placeholder = 'ËæìÂÖ•ÂÜÖÂÆπÔºåShift+EnterÊç¢Ë°åÔºåEnterÂèëÈÄÅ...';
            discussionState.waitingForUser = false;
            isRequestInProgress = false;
            currentDiscussionId = null;
            
            // Âº∫Âà∂Ê∏ÖÁêÜÊâÄÊúâËÆ®ËÆ∫Áõ∏ÂÖ≥Áä∂ÊÄÅ
            discussionState.isPaused = false;
            isDiscussionMode = false;
            
            // Á°Æ‰øùÊ∏ÖÁêÜeventSource
            if (currentDiscussionEventSource) {
                try {
                    currentDiscussionEventSource.close();
                } catch (e) {
                    console.log('EventSourceÂ∑≤ÂÖ≥Èó≠:', e);
                }
                currentDiscussionEventSource = null;
            }
            
            console.log('ËæìÂÖ•Ê°ÜÂ∑≤ÈáçÁΩÆ‰∏∫Ê≠£Â∏∏Áä∂ÊÄÅÔºåÊâÄÊúâËÆ®ËÆ∫Áä∂ÊÄÅÂ∑≤Ê∏ÖÁêÜ');
        }
        
        // Áî®Êà∑Âú®ÊöÇÂÅúÊúüÈó¥ÂèëË®Ä
        function sendUserIntervention(content) {
            if (!currentDiscussionId || !discussionState.isPaused) return;
            
            // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
            allMessages.push({
                role: 'user',
                content: content,
                timestamp: Date.now()
            });
            renderChat();
            
            // ÂèëÈÄÅÁî®Êà∑ÊèíÂÖ•ÂèëË®ÄÂà∞ÊúçÂä°Âô®
            fetch('http://127.0.0.1:5000/user_intervention', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    discussion_id: currentDiscussionId,
                    message: content
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Áî®Êà∑ÊèíÂÖ•ÂèëË®ÄÂìçÂ∫î:', data);
                
                // Ëá™Âä®ÁªßÁª≠ËÆ®ËÆ∫
                discussionState.isPaused = false;
                updatePauseButton();
                updateDiscussionStatus('ËÆ®ËÆ∫‰∏≠...');
                disableUserInput();
                
                addSystemMessage('Áî®Êà∑Â∑≤Âä†ÂÖ•ËÆ®ËÆ∫ÔºåÁªßÁª≠...');
            })
            .catch(err => {
                console.error('Áî®Êà∑ÊèíÂÖ•ÂèëË®ÄÂ§±Ë¥•:', err);
            });
        }
        
        // Á°Æ‰øùÁ≥ªÁªüÊ∂àÊÅØÂú®È°µÈù¢Âä†ËΩΩÂêéÁ´ãÂç≥ÊòæÁ§∫
        window.addEventListener('DOMContentLoaded', (event) => {
            addSystemMessage(`Agent 1 Â∑≤Âä†ÂÖ•ËÅäÂ§©`);
            
            // Ê∑ªÂä†ÊöÇÂÅú/ÁªßÁª≠ÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨
            document.getElementById('pauseDiscussion').addEventListener('click', pauseResumeDiscussion);
            
            // Ê∑ªÂä†ÂÅúÊ≠¢ËÆ®ËÆ∫ÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨
            document.getElementById('stopDiscussion').addEventListener('click', stopDiscussion);
        });
    </script>
</body>
</html>
